<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Geral - Pol√≠cia Penal SP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            padding: 20px;
            border-bottom: 3px solid #dc143c;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #ffffff;
            font-size: 28px;
            font-weight: 600;
        }

        .header h2 {
            color: #b0b0b0;
            font-size: 16px;
            font-weight: 400;
            margin-top: 5px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: #dc143c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            padding: 5px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .upload-section {
            background: rgba(45, 45, 45, 0.9);
            border: 2px dashed #dc143c;
            border-radius: 10px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #ff1744;
            background: rgba(60, 60, 60, 0.9);
        }

        .upload-section h3 {
            color: #dc143c;
            font-size: 22px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .upload-section p {
            color: #b0b0b0;
            margin-bottom: 20px;
        }

        #fileInput {
            display: none;
        }

        .upload-btn {
            background: #dc143c;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .upload-btn:hover {
            background: #b01030;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 20, 60, 0.4);
        }

        .tabs-container {
            background: rgba(45, 45, 45, 0.9);
            border: 2px solid #dc143c;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .tabs-header {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dc143c;
            padding-bottom: 15px;
        }

        .tab-button {
            padding: 12px 20px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 5px;
            color: #b0b0b0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .tab-button:hover {
            background: #2d2d2d;
            color: #fff;
        }

        .tab-button.active {
            background: #dc143c;
            color: white;
            border-color: #dc143c;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filters-section {
            background: rgba(35, 35, 35, 0.8);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .filters-title {
            color: #dc143c;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: #b0b0b0;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #1a1a1a;
            color: #ffffff;
            font-size: 13px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 0 2px rgba(220, 20, 60, 0.2);
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: #dc143c;
            color: white;
        }

        .btn-primary:hover {
            background: #b01030;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #555;
            color: white;
        }

        .btn-secondary:hover {
            background: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border: 2px solid #dc143c;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(220, 20, 60, 0.3);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #dc143c;
            margin: 10px 0;
        }

        .stat-label {
            color: #b0b0b0;
            font-size: 12px;
            text-transform: uppercase;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: rgba(45, 45, 45, 0.9);
            border: 2px solid #dc143c;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            color: #dc143c;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
            border-left: 4px solid #dc143c;
            padding-left: 12px;
        }

        .table-container {
            background: rgba(45, 45, 45, 0.9);
            border: 2px solid #dc143c;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #dc143c;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #444;
            color: #e0e0e0;
            font-size: 12px;
        }

        tr:hover {
            background: rgba(220, 20, 60, 0.15);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #dc143c;
            font-size: 16px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Dashboard Geral - Pol√≠cia Penal do Estado de S√£o Paulo</h1>
                <h2>Coordenadoria de Execu√ß√£o Penal da Regi√£o Noroeste</h2>
            </div>
            <div class="logo">
                POLICIA<br>PENAL<br>SP
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h3>üìÇ Fazer Upload da Planilha</h3>
            <p>Carregue o arquivo Excel (.xlsx) para an√°lise autom√°tica de todas as abas</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Selecionar Arquivo Excel
            </button>
            <p id="fileName" style="margin-top: 15px; color: #dc143c; font-weight: 600;"></p>
        </div>

        <div class="loading" id="loading">
            <p>‚è≥ Processando planilha...</p>
        </div>

        <!-- Tabs Container -->
        <div class="tabs-container" id="tabsContainer">
            <div class="tabs-header" id="tabsHeader"></div>
            <div id="tabsContent"></div>
        </div>
    </div>

    <script>
        let allData = {};
        let currentTab = '';
        let filteredData = {};
        let charts = {};

        const colors = {
            primary: '#dc143c',
            secondary: '#b01030',
            dark: '#1a1a1a',
            gray: '#2d2d2d',
            light: '#b0b0b0'
        };

        // Upload de arquivo
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = `Arquivo: ${file.name}`;
            document.getElementById('loading').classList.add('active');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    allData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        allData[sheetName] = jsonData;
                    });

                    initializeDashboard();
                } catch (error) {
                    alert('Erro ao processar arquivo: ' + error.message);
                } finally {
                    document.getElementById('loading').classList.remove('active');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function initializeDashboard() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('tabsContainer').style.display = 'block';

            createTabs();
            if (Object.keys(allData).length > 0) {
                switchTab(Object.keys(allData)[0]);
            }
        }

        function createTabs() {
            const tabsHeader = document.getElementById('tabsHeader');
            tabsHeader.innerHTML = '';

            Object.keys(allData).forEach(sheetName => {
                const button = document.createElement('button');
                button.className = 'tab-button';
                button.textContent = sheetName;
                button.onclick = () => switchTab(sheetName);
                tabsHeader.appendChild(button);
            });
        }

        function switchTab(sheetName) {
            currentTab = sheetName;
            filteredData[sheetName] = [...allData[sheetName]];

            // Atualizar bot√µes ativos
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === sheetName);
            });

            renderTabContent(sheetName);
        }

        function renderTabContent(sheetName) {
            const data = allData[sheetName];
            const tabsContent = document.getElementById('tabsContent');
            
            if (data.length === 0) {
                tabsContent.innerHTML = '<p style="text-align:center; color:#b0b0b0;">Nenhum dado dispon√≠vel nesta aba.</p>';
                return;
            }

            const columns = Object.keys(data[0]);
            const unidadeCol = columns.find(col => col.toLowerCase().includes('unidade') || col.toLowerCase().includes('estabelecimento'));

            tabsContent.innerHTML = `
                <div class="tab-content active">
                    <!-- Filtros -->
                    <div class="filters-section">
                        <h3 class="filters-title">üîç Filtros</h3>
                        <div class="filters-grid" id="filtersGrid_${sheetName}"></div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary" onclick="applyFilters('${sheetName}')">Aplicar</button>
                            <button class="btn btn-secondary" onclick="clearFilters('${sheetName}')">Limpar</button>
                            <button class="btn btn-secondary" onclick="exportCSV('${sheetName}')">üì• Exportar CSV</button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="stats-grid" id="stats_${sheetName}"></div>

                    <!-- Gr√°ficos -->
                    <div class="charts-grid" id="charts_${sheetName}"></div>

                    <!-- Tabela -->
                    <div class="table-container">
                        <h3 class="chart-title">üìã Dados Detalhados - ${sheetName}</h3>
                        <table id="table_${sheetName}"></table>
                    </div>
                </div>
            `;

            createFilters(sheetName);
            updateStats(sheetName);
            createCharts(sheetName);
            updateTable(sheetName);
        }

        function createFilters(sheetName) {
            const data = allData[sheetName];
            const columns = Object.keys(data[0]);
            const filtersGrid = document.getElementById(`filtersGrid_${sheetName}`);
            
            // Adicionar filtro de unidade se existir
            const unidadeCol = columns.find(col => 
                col.toLowerCase().includes('unidade') || 
                col.toLowerCase().includes('estabelecimento')
            );

            if (unidadeCol) {
                const unidades = [...new Set(data.map(row => row[unidadeCol]).filter(v => v))];
                const filterDiv = document.createElement('div');
                filterDiv.className = 'filter-group';
                filterDiv.innerHTML = `
                    <label>${unidadeCol}</label>
                    <select id="filter_${sheetName}_unidade">
                        <option value="">Todas</option>
                        ${unidades.map(u => `<option value="${u}">${u}</option>`).join('')}
                    </select>
                `;
                filtersGrid.appendChild(filterDiv);
            }

            // Adicionar filtros para colunas com poucos valores √∫nicos
            columns.slice(0, 5).forEach(col => {
                if (col === unidadeCol) return;
                const uniqueValues = [...new Set(data.map(row => row[col]).filter(v => v !== '' && v !== null))];
                if (uniqueValues.length > 0 && uniqueValues.length <= 20) {
                    const filterDiv = document.createElement('div');
                    filterDiv.className = 'filter-group';
                    filterDiv.innerHTML = `
                        <label>${col}</label>
                        <select id="filter_${sheetName}_${col.replace(/\s+/g, '_')}">
                            <option value="">Todos</option>
                            ${uniqueValues.map(v => `<option value="${v}">${v}</option>`).join('')}
                        </select>
                    `;
                    filtersGrid.appendChild(filterDiv);
                }
            });
        }

        function applyFilters(sheetName) {
            const selects = document.querySelectorAll(`#filtersGrid_${sheetName} select`);
            filteredData[sheetName] = allData[sheetName].filter(row => {
                for (let select of selects) {
                    if (select.value) {
                        const label = select.previousElementSibling.textContent;
                        if (row[label] != select.value) return false;
                    }
                }
                return true;
            });

            updateStats(sheetName);
            updateCharts(sheetName);
            updateTable(sheetName);
        }

        function clearFilters(sheetName) {
            document.querySelectorAll(`#filtersGrid_${sheetName} select`).forEach(s => s.value = '');
            filteredData[sheetName] = [...allData[sheetName]];
            updateStats(sheetName);
            updateCharts(sheetName);
            updateTable(sheetName);
        }

        function updateStats(sheetName) {
            const data = filteredData[sheetName] || allData[sheetName];
            const statsDiv = document.getElementById(`stats_${sheetName}`);
            const columns = Object.keys(data[0]);

            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total de Registros</div>
                    <div class="stat-value">${data.length}</div>
                </div>
            `;

            // Estat√≠sticas num√©ricas
            const numericCols = columns.filter(col => {
                return data.some(row => typeof row[col] === 'number');
            }).slice(0, 3);

            numericCols.forEach(col => {
                const values = data.map(row => parseFloat(row[col]) || 0);
                const sum = values.reduce((a, b) => a + b, 0);
                const avg = sum / values.length;
                
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-label">${col}</div>
                        <div class="stat-value">${Math.round(avg)}</div>
                        <div class="stat-label" style="font-size: 10px; margin-top: 5px;">M√©dia</div>
                    </div>
                `;
            });

            statsDiv.innerHTML = statsHTML;
        }

        function createCharts(sheetName) {
            const data = filteredData[sheetName] || allData[sheetName];
            const chartsDiv = document.getElementById(`charts_${sheetName}`);
            const columns = Object.keys(data[0]);

            let chartsHTML = '';

            // Chart 1: Distribui√ß√£o de valores da primeira coluna categ√≥rica
            const catCol = columns.find(col => {
                const uniqueValues = [...new Set(data.map(row => row[col]))];
                return uniqueValues.length > 2 && uniqueValues.length <= 30;
            });

            if (catCol) {
                chartsHTML += `
                    <div class="chart-card">
                        <h3 class="chart-title">üìä ${catCol}</h3>
                        <canvas id="chart1_${sheetName}"></canvas>
                    </div>
                `;
            }

            // Chart 2: Valores num√©ricos
            const numCol = columns.find(col => data.some(row => typeof row[col] === 'number'));
            
            if (numCol) {
                chartsHTML += `
                    <div class="chart-card">
                        <h3 class="chart-title">üìà ${numCol}</h3>
                        <canvas id="chart2_${sheetName}"></canvas>
                    </div>
                `;
            }

            chartsDiv.innerHTML = chartsHTML;

            // Criar gr√°ficos
            setTimeout(() => {
                if (catCol) createCategoricalChart(sheetName, catCol, `chart1_${sheetName}`);
                if (numCol) createNumericChart(sheetName, numCol, `chart2_${sheetName}`);
            }, 100);
        }

        function createCategoricalChart(sheetName, column, canvasId) {
            const data = filteredData[sheetName] || allData[sheetName];
            const counts = {};
            
            data.forEach(row => {
                const value = row[column] || 'N√£o Informado';
                counts[value] = (counts[value] || 0) + 1;
            });

            const sortedData = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 15);

            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(d => d[0]),
                    datasets: [{
                        label: column,
                        data: sortedData.map(d => d[1]),
                        backgroundColor: colors.primary,
                        borderColor: colors.secondary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { labels: { color: colors.light } }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: colors.light },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: colors.light, font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createNumericChart(sheetName, column, canvasId) {
            const data = filteredData[sheetName] || allData[sheetName];
            const values = data.map(row => parseFloat(row[column]) || 0);
            
            const unidadeCol = Object.keys(data[0]).find(col => 
                col.toLowerCase().includes('unidade') || 
                col.toLowerCase().includes('estabelecimento')
            );

            const labels = unidadeCol ? data.map(row => row[unidadeCol]) : data.map((_, i) => `Item ${i + 1}`);

            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.slice(0, 20),
                    datasets: [{
                        label: column,
                        data: values.slice(0, 20),
                        backgroundColor: colors.primary,
                        borderColor: colors.secondary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: colors.light } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: colors.light },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: colors.light, font: { size: 9 }, maxRotation: 90 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateCharts(sheetName) {
            createCharts(sheetName);
        }

        function updateTable(sheetName) {
            const data = filteredData[sheetName] || allData[sheetName];
            const table = document.getElementById(`table_${sheetName}`);
            if (!table) return;

            const columns = Object.keys(data[0]);
            const displayData = data.slice(0, 50); // Limitar a 50 linhas

            let html = '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            displayData.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || '-'}</td>`;
                });
                html += '</tr>';
            });

            if (data.length > 50) {
                html += `<tr><td colspan="${columns.length}" style="text-align: center; color: ${colors.primary}; font-style: italic;">Mostrando 50 de ${data.length} registros</td></tr>`;
            }

            html += '</tbody>';
            table.innerHTML = html;
        }

        function exportCSV(sheetName) {
            const data = filteredData[sheetName] || allData[sheetName];
            const columns = Object.keys(data[0]);
            
            let csv = columns.join(';') + '\n';
            data.forEach(row => {
                csv += columns.map(col => row[col] || '').join(';') + '\n';
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${sheetName}_filtrado.csv`;
            link.click();
        }
    </script>
</body>
</html>
